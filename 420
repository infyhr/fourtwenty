#!/usr/bin/env php
<?php
if(PHP_SAPI !== 'cli') {
    die('This application can only be run from the command line interface.');
}

class fourtwenty {

    public $argv, $argc;
    const VERSION = 1.3;

    /**
     * Class constructor. Registers $argv and $argc and accepts initial input.
     * @param string $argv Command line arguments
     * @param int $argc Number of command line arguments
     * @return void
     */
    public function __construct($argv, $argc) {
        $this->argv = $argv;
        $this->argc = $argc;

        if(!isset($this->argv[1])) { $this->e('Usage: php 420 [command]', FALSE);return; }

        if(method_exists($this, $argv[1]) && is_callable(array($this, $argv[1]))) {
            $this->$argv[1]();
        }else {
            $this->help();
        }
    }

    /**
     * Shows help.
     * @return void
     */
    public function help() {
        // List all the available and callable functions which are public.
        $reflector = new ReflectionClass($this);
        $methods   = $reflector->getMethods(ReflectionMethod::IS_PUBLIC);

        $available = array();

        foreach($methods as $method) {
            if((string)$method->name == '__construct') { continue; }
            $available[] = (string)$method->name;
        }

        $available = implode(', ', $available);
        $this->e('Available methods: ' . $available);
    }

    /**
     * Sets up a new user page.
     * @return void
     */
    public function newpage() {
        // Get the new page name.
        $name = $this->ask('Name of the new page:', 'My awesome page');
        // Now ask for the slug
        $slug = $this->ask('Slug for the new page:', 'awesomepage');

        // Some bootstrap for the user:
        $page = <<<HTML
<?php
/*
Template Name: $name
*/

get_header();
?>

<!-- Write your HTML code here -->
<!-- Generated by 420 -->

<?php get_footer(); ?>
HTML;

        // Call file_put_contents.
        if(file_put_contents('./page-' . $slug . '.php', $page)) {
            $this->e('File page-' . $slug . '.php has been successfully created!');
        }else {
            $this->e('There has been an erroring creating page-' . $slug . '.php!', FALSE);
        }
    }

    /**
     * Checks for updates.
     * @return void
     */
    public function update() {
        // Grab the latest manifest.txt
        $latest_branch = file_get_contents('https://raw.githubusercontent.com/infyhr/fourtwenty/master/manifest.txt');
        if(!$latest_branch) { $this->e('Unabled to check for updates. Check whether allow_url_fopen is enabled.');return; }

        // Compare current and latest.
        $this->e('Current: ' . self::VERSION);
        $this->e('Latest: ' . $latest_branch);

        if($latest_branch > self::VERSION) { $this->e('Update available!'); }
        return;
    }

    /**
     * Sets the theme up. This is done by editing style.css
     * @return void
     */
    public function setup() {
        // Interactively ask the user for some information.
        $replacements                   = array();
        $replacements['name']           = $this->ask('Name of the new theme: ');
        $replacements['theme_uri']      = $this->ask('Theme URI: ');
        $replacements['author_name']    = $this->ask('Author name: ');
        $replacements['author_uri']     = $this->ask('Author URI: ');
        $replacements['description']    = $this->ask('Description: ');

        // Try to open our style.css.
        $fp = fopen('./style.css', 'rb');
        if(!$fp) { $this->e('Could not open style.css. Please ensure it\'s readable'); }
        $data = fread($fp, filesize('./style.css')); // Read it into $data

        // Run string replacements.
        $data = str_replace(['420_name', '420_uri', '420_author', '420_authoruri', '420_description'], $replacements, $data);

        // Finally update the file.
        if(!file_put_contents('./style.css', $data)) {
            $this->e('An error has occured while writing to style.css. Please ensure it\'s writable!');return;
        }
        $this->e('Updated style.css successfully!');
    }

    /**
     * Gets the user input and returns it.
     * @param string $question String displayed to the user. What to expect from the user themselves.
     * @param example $example Shows an example for the question.
     * @return string
     */
    private function ask($question, $example = NULL) {
        $this->e($question);
        if($example) { $this->e("\t" . 'Example: ' . $example); }
        echo '> ';
        $handle = fopen('php://STDIN', 'r');
        return trim(fgets($handle));
    }

    /**
     * Echoes out text with colors, in a pretty way.
     * @param string $msg What to echo.
     * @param bool $good Whether the message is positive or negative. Changes colors accordingly.
     * @return void
     */
    private function e($msg, $good = TRUE) {
        if($good) {
            $color = "\033[94m ";
        }else {
            $color = "\033[91m";
        }

        echo $color . $msg . "\033[0m" . "\n"; # \n because this is expected to run on unix.
    }
}

new fourtwenty($argv, $argc);

?>
